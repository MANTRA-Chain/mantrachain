package v7rc0

import (
	"errors"
	"math/big"

	sdk "github.com/cosmos/cosmos-sdk/types"
	evmkeeper "github.com/cosmos/evm/x/vm/keeper"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/holiman/uint256"
)

const (
	NameSlot   = 0
	SymbolSlot = 1
)

// protect a few more slots from being modified
var ProtectSlots = []int64{2, 3, 4, 5}

var WOMContractAddress = map[string][]common.Address{
	"mantra-1":        {common.HexToAddress("0xE3047710EF6cB36Bcf1E58145529778eA7Cb5598")},
	"mantra-dukong-1": {common.HexToAddress("0x10d26F0491fA11c5853ED7C1f9817b098317DC46")},
	"mantra-canary-net-1": {
		common.HexToAddress("0x523A024258fc56E4d6d79D4367a98F2548A9f401"),
		common.HexToAddress("0x9d4a99D8f81647649D983d23599e4B1DA164228F"), // e2e test
	},
	"mantra-dryrun-1": {common.HexToAddress("0x523A024258fc56E4d6d79D4367a98F2548A9f401")},
}

var WMANTRAByteCode = common.Hex2Bytes("0x60806040526004361061009f575f3560e01c8063313ce56711610063578063313ce567146101a657806370a08231146101d057806395d89b411461020c578063a9059cbb14610236578063d0e30db014610272578063dd62ed3e1461027c576100ae565b806306fdde03146100b2578063095ea7b3146100dc57806318160ddd1461011857806323b872dd146101425780632e1a7d4d1461017e576100ae565b366100ae576100ac6102b8565b005b5f5ffd5b3480156100bd575f5ffd5b506100c66103c0565b6040516100d39190610cf1565b60405180910390f35b3480156100e7575f5ffd5b5061010260048036038101906100fd9190610da2565b61044c565b60405161010f9190610dfa565b60405180910390f35b348015610123575f5ffd5b5061012c6105a7565b6040516101399190610e22565b60405180910390f35b34801561014d575f5ffd5b5061016860048036038101906101639190610e3b565b6105ae565b6040516101759190610dfa565b60405180910390f35b348015610189575f5ffd5b506101a4600480360381019061019f9190610e8b565b610735565b005b3480156101b1575f5ffd5b506101ba61096d565b6040516101c79190610ed1565b60405180910390f35b3480156101db575f5ffd5b506101f660048036038101906101f19190610eea565b610972565b6040516102039190610e22565b60405180910390f35b348015610217575f5ffd5b50610220610987565b60405161022d9190610cf1565b60405180910390f35b348015610241575f5ffd5b5061025c60048036038101906102579190610da2565b610a13565b6040516102699190610dfa565b60405180910390f35b61027a6102b8565b005b348015610287575f5ffd5b506102a2600480360381019061029d9190610f15565b610a29565b6040516102af9190610e22565b60405180910390f35b3460035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8282546103049190610f80565b925050819055503373ffffffffffffffffffffffffffffffffffffffff167fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c346040516103519190610e22565b60405180910390a23373ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef346040516103b69190610e22565b60405180910390a3565b600180546103cd90610fe0565b80601f01602080910402602001604051908101604052809291908181526020018280546103f990610fe0565b80156104445780601f1061041b57610100808354040283529160200191610444565b820191905f5260205f20905b81548152906001019060200180831161042757829003601f168201915b505050505081565b5f5f73ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16036104bb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104b29061105a565b60405180910390fd5b8160045f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516105959190610e22565b60405180910390a36001905092915050565b5f47905090565b5f5f60045f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205490507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811461071e5782811015610695576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161068c906110c2565b60405180910390fd5b82816106a191906110e0565b60045f8773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055505b610729858585610a49565b60019150509392505050565b61073d610c34565b5f60035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20549050818110156107c1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107b89061115d565b60405180910390fd5b81810360035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055503373ffffffffffffffffffffffffffffffffffffffff167f7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b658360405161084b9190610e22565b60405180910390a25f73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516108b09190610e22565b60405180910390a35f3373ffffffffffffffffffffffffffffffffffffffff16836040516108dd906111a8565b5f6040518083038185875af1925050503d805f8114610917576040519150601f19603f3d011682016040523d82523d5f602084013e61091c565b606091505b5050905080610960576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161095790611206565b60405180910390fd5b505061096a610c78565b50565b601281565b6003602052805f5260405f205f915090505481565b6002805461099490610fe0565b80601f01602080910402602001604051908101604052809291908181526020018280546109c090610fe0565b8015610a0b5780601f106109e257610100808354040283529160200191610a0b565b820191905f5260205f20905b8154815290600101906020018083116109ee57829003601f168201915b505050505081565b5f610a1f338484610a49565b6001905092915050565b6004602052815f5260405f20602052805f5260405f205f91509150505481565b5f73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1603610ab7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610aae90611294565b60405180910390fd5b5f60035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054905081811015610b3b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b329061115d565b60405180910390fd5b81810360035f8673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055508160035f8573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f82825401925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610c269190610e22565b60405180910390a350505050565b60025f5403610c6f576040517f3ee5aeb500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60025f81905550565b60015f81905550565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610cc382610c81565b610ccd8185610c8b565b9350610cdd818560208601610c9b565b610ce681610ca9565b840191505092915050565b5f6020820190508181035f830152610d098184610cb9565b905092915050565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610d3e82610d15565b9050919050565b610d4e81610d34565b8114610d58575f5ffd5b50565b5f81359050610d6981610d45565b92915050565b5f819050919050565b610d8181610d6f565b8114610d8b575f5ffd5b50565b5f81359050610d9c81610d78565b92915050565b5f5f60408385031215610db857610db7610d11565b5b5f610dc585828601610d5b565b9250506020610dd685828601610d8e565b9150509250929050565b5f8115159050919050565b610df481610de0565b82525050565b5f602082019050610e0d5f830184610deb565b92915050565b610e1c81610d6f565b82525050565b5f602082019050610e355f830184610e13565b92915050565b5f5f5f60608486031215610e5257610e51610d11565b5b5f610e5f86828701610d5b565b9350506020610e7086828701610d5b565b9250506040610e8186828701610d8e565b9150509250925092565b5f60208284031215610ea057610e9f610d11565b5b5f610ead84828501610d8e565b91505092915050565b5f60ff82169050919050565b610ecb81610eb6565b82525050565b5f602082019050610ee45f830184610ec2565b92915050565b5f60208284031215610eff57610efe610d11565b5b5f610f0c84828501610d5b565b91505092915050565b5f5f60408385031215610f2b57610f2a610d11565b5b5f610f3885828601610d5b565b9250506020610f4985828601610d5b565b9150509250929050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610f8a82610d6f565b9150610f9583610d6f565b9250828201905080821115610fad57610fac610f53565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610ff757607f821691505b60208210810361100a57611009610fb3565b5b50919050565b7f574d414e5452413a20617070726f766520746f207a65726f20616464726573735f82015250565b5f611044602083610c8b565b915061104f82611010565b602082019050919050565b5f6020820190508181035f83015261107181611038565b9050919050565b7f574d414e5452413a20696e73756666696369656e7420616c6c6f77616e6365005f82015250565b5f6110ac601f83610c8b565b91506110b782611078565b602082019050919050565b5f6020820190508181035f8301526110d9816110a0565b9050919050565b5f6110ea82610d6f565b91506110f583610d6f565b925082820390508181111561110d5761110c610f53565b5b92915050565b7f574d414e5452413a20696e73756666696369656e742062616c616e63650000005f82015250565b5f611147601d83610c8b565b915061115282611113565b602082019050919050565b5f6020820190508181035f8301526111748161113b565b9050919050565b5f81905092915050565b50565b5f6111935f8361117b565b915061119e82611185565b5f82019050919050565b5f6111b282611188565b9150819050919050565b7f574d414e5452413a20455448207472616e73666572206661696c6564000000005f82015250565b5f6111f0601c83610c8b565b91506111fb826111bc565b602082019050919050565b5f6020820190508181035f83015261121d816111e4565b9050919050565b7f574d414e5452413a207472616e7366657220746f207a65726f206164647265735f8201527f7300000000000000000000000000000000000000000000000000000000000000602082015250565b5f61127e602183610c8b565b915061128982611224565b604082019050919050565b5f6020820190508181035f8301526112ab81611272565b905091905056fea2646970667358221220aac108d399fd7aaad685bcfd97bc6134c5be8ced3af1791d06f2819b70cb968864736f6c634300081d0033")

func migrateWOMs(ctx sdk.Context, evmKeeper evmkeeper.Keeper) error {
	addresses := WOMContractAddress[ctx.ChainID()]
	for _, addr := range addresses {
		if err := migrateWOM(ctx, evmKeeper, addr); err != nil {
			return err
		}
	}
	return nil
}

func migrateWOM(ctx sdk.Context, evmKeeper evmkeeper.Keeper, contract common.Address) error {
	// build excluded slots for name symbol fields
	excluded := make(map[common.Hash]struct{})

	// assume 0 and 1 are slots for name and symbol strings.
	for _, slot := range []int{NameSlot, SymbolSlot} {
		slots, err := stringSlots(ctx, evmKeeper, contract, slot)
		if err != nil {
			return err
		}

		for _, s := range slots {
			excluded[s] = struct{}{}
		}
	}

	for _, slot := range ProtectSlots {
		s := common.BigToHash(big.NewInt(slot))
		excluded[s] = struct{}{}
	}

	setStringField(ctx, evmKeeper, contract, NameSlot, "WMANTRA Token")
	setStringField(ctx, evmKeeper, contract, SymbolSlot, "WMANTRA")

	evmKeeper.ForEachStorage(ctx, contract, func(key, value common.Hash) bool {
		if _, ok := excluded[key]; ok {
			return true
		}

		// assume to be balance or allowance slots, multiply value by 4
		val := uint256.NewInt(0).SetBytes(value.Bytes())

		var overflow bool
		val, overflow = val.MulOverflow(val, uint256.NewInt(4))

		if overflow {
			// set to max uint256 when overflow
			value = common.MaxHash
		} else {
			value = common.BigToHash(val.ToBig())
		}

		evmKeeper.SetState(ctx, contract, key, value.Bytes())
		return true
	})

	// update bytecode
	codeHash := crypto.Keccak256Hash(WMANTRAByteCode)
	evmKeeper.SetCode(ctx, codeHash.Bytes(), WMANTRAByteCode)
	evmKeeper.SetCodeHash(ctx, contract.Bytes(), codeHash.Bytes())
	return nil
}

// stringSlots computes all the storage slots related to a string field located at given slot
func stringSlots(ctx sdk.Context, evmKeeper evmkeeper.Keeper, contract common.Address, slot int) ([]common.Hash, error) {
	var slots []common.Hash

	// get length slot
	lengthSlot := common.BigToHash(big.NewInt(int64(slot)))
	slots = append(slots, lengthSlot)

	// get length value
	lengthValue := evmKeeper.GetState(ctx, contract, lengthSlot)

	if lengthValue[31]%2 == 0 {
		// short string
		return slots, nil
	}

	lengthBig := new(big.Int).SetBytes(lengthValue.Bytes())
	lengthBig = new(big.Int).Rsh(lengthBig, 1) // length = length / 2
	if !lengthBig.IsUint64() {
		return nil, errors.New("string length exceeds uint64")
	}
	length := lengthBig.Int64()
	if length == 0 {
		return slots, nil
	}

	if length > 1024 {
		return nil, errors.New("string length too large")
	}

	// padded length to 32 bytes slots
	numDataSlots := (length + 31) / 32

	// compute data slots
	dataStart := new(big.Int).SetBytes(crypto.Keccak256(lengthSlot.Bytes()))
	for i := int64(0); i < numDataSlots; i++ {
		dataSlot := common.BigToHash(new(big.Int).Add(dataStart, big.NewInt(i)))
		slots = append(slots, dataSlot)
	}

	return slots, nil
}

func setStringField(ctx sdk.Context, evmKeeper evmkeeper.Keeper, contract common.Address, slot int, value string) {
	if len(value) >= 32 {
		panic("string length exceeds 31 bytes")
	}
	lengthSlot := common.BigToHash(big.NewInt(int64(slot)))

	var data common.Hash
	copy(data[:], []byte(value))
	data[31] = byte(len(value) * 2) // length * 2 for short string

	evmKeeper.SetState(ctx, contract, lengthSlot, data.Bytes())
}
